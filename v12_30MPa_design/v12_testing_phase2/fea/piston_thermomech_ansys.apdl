! ============================================================
! ANSYS APDL SCRIPT: PISTON CROWN THERMO‑MECHANICAL ANALYSIS
! V12 Hypercar – 30 MPa peak pressure, 12 k RPM
! Geometry: piston_crown_15.0mm.step (axisymmetric)
! ============================================================

/FILNAME,piston_crown_thermomech
/TITLE,Piston crown coupled thermo‑mechanical – 30 MPa, 3000 whp

! ------------------------------------------------------------
! 1. PREPROCESSOR
! ------------------------------------------------------------
/PREP7

! 1.1 Material properties – forged steel (4340)
! Elastic
MP,EX,1,210e3           ! Young's modulus [MPa]
MP,PRXY,1,0.29          ! Poisson's ratio
MP,DENS,1,7.85e-9       ! Density [tonne/mm³]

! Thermal
MP,ALPX,1,1.2e-5        ! Thermal expansion coefficient [1/K]
MP,KXX,1,0.050          ! Thermal conductivity [W/(mm·K)]
MP,C,1,0.46             ! Specific heat [J/(g·K)]

! Plasticity (bilinear isotropic hardening)
TB,BISO,1,1,2
TBDATA,,386,0           ! Yield stress 386 MPa, tangent modulus 0 (elastic‑perfectly plastic)

! 1.2 Import geometry
! Assumes STEP file has been imported via GUI or ~CATIA command
! Alternative: create axisymmetric area manually
! R1 = 47.25 mm (bore radius), crown thickness = 15.0 mm
! For simplicity, we define a rectangle
RAD=47.25
THICK=15.0
K,1,0,0,0
K,2,RAD,0,0
K,3,RAD,THICK,0
K,4,0,THICK,0
A,1,2,3,4               ! Create area

! 1.3 Element type
! Coupled‑field axisymmetric quadrilateral (PLANE223)
ET,1,PLANE223           ! 8‑node coupled‑field quadrilateral
KEYOPT,1,1,11           ! Axisymmetric with UX,UY,TEMP DOFs
KEYOPT,1,3,0            ! Uniform temperature

! 1.4 Mesh
ESIZE,2.0               ! Element size 2 mm
AMESH,1                 ! Mesh area
EPLOT

! ------------------------------------------------------------
! 2. LOADS & BOUNDARY CONDITIONS
! ------------------------------------------------------------

! 2.1 Boundary conditions
! Bottom edge (z=0): fixed in Z (UY=0), free in radial (UX)
LSEL,S,LOC,Y,0
DL,ALL,,UY,0            ! Fix vertical displacement
LSEL,ALL

! Symmetry axis (r=0): fixed radial displacement (UX=0)
LSEL,S,LOC,X,0
DL,ALL,,UX,0
LSEL,ALL

! 2.2 Thermal loads
! Crown top surface (y=THICK): heat flux
LSEL,S,LOC,Y,THICK
SFL,ALL,HFLUX,0.003     ! 0.003 W/mm² = 3 MW/m² (typical combustion)
LSEL,ALL

! Crown bottom surface (y=0): convection (water‑jacket + oil‑jet)
LSEL,S,LOC,Y,0
SFL,ALL,CONV,0.015,90   ! h=0.015 W/(mm²·K)=15000 W/(m²·K), T_bulk=90°C
LSEL,ALL

! Initial temperature
TUNIF,90                ! Initial temperature 90°C

! 2.3 Pressure load (mechanical)
! Crown top surface: uniform pressure 30 MPa
LSEL,S,LOC,Y,THICK
SFL,ALL,PRES,30         ! 30 MPa pressure
LSEL,ALL

! ------------------------------------------------------------
! 3. SOLUTION
! ------------------------------------------------------------
/SOLU
ANTYPE,STATIC           ! Steady‑state analysis
NLGEOM,ON               ! Include geometric nonlinearity (large deformation)
NSUBST,10,20,5          ! Number of substeps
OUTRES,ALL,ALL          ! Write all results for each substep
SOLVE
FINISH

! ------------------------------------------------------------
! 4. POSTPROCESSING
! ------------------------------------------------------------
/POST1

! 4.1 Plot temperature distribution
PLNSOL,TEMP             ! Nodal temperature
/OUTPUT,temp_results,txt
PRNSOL,TEMP
/OUTPUT

! 4.2 Plot von‑Mises stress
PLNSOL,S,EQV            ! Equivalent von‑Mises stress
/OUTPUT,stress_results,txt
PRNSOL,S,EQV
/OUTPUT

! 4.3 Safety factor based on yield strength (386 MPa)
ETABLE,SEQV,S,EQV       ! Create element table for von‑Mises stress
SMAX,SEQV_MAX,VMAX,SEQV ! Find maximum SEQV
*GET,SF,ACTIVE,0,ETAB,SEQV_MAX
SF=386/SF               ! Safety factor = yield / max stress
*STATUS,SF

! 4.4 Path plot along crown thickness
PATH,CROWN,2            ! Define path with 2 points
PPATH,1,0,0,0           ! Point 1 at bottom (r=0, z=0)
PPATH,2,0,THICK,0       ! Point 2 at top (r=0, z=THICK)
PDEF,TEMP,TEMP          ! Map temperature onto path
PLPATH,TEMP
PDEF,STRESS,S,EQV       ! Map von‑Mises stress onto path
PLPATH,STRESS

! ------------------------------------------------------------
! 5. SAVE RESULTS & EXIT
! ------------------------------------------------------------
SAVE
FINISH

! ============================================================
! NOTES
! ============================================================
! 1. This script assumes axisymmetric geometry; for full 3D,
!    use SOLID226 elements and apply cyclic symmetry.
! 2. The convection coefficient (0.015 W/(mm²·K)) combines
!    water‑jacket (h=0.008) and oil‑jet impingement (additional).
! 3. Critical heat flux = 0.347 W/mm² – well above applied 0.003.
! 4. To run: import STEP file, or use the rectangle geometry above.
! 5. For transient thermal analysis, switch to ANTYPE,TRANSIENT.
! ============================================================